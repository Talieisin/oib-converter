# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OIB Converter transforms Microsoft Intune Settings Catalogue JSON profiles from [OpenIntuneBaseline](https://github.com/SkipToTheEndpoint/OpenIntuneBaseline) into Apple Configuration Profile (.mobileconfig) format. It uses the Microsoft Graph API schema to accurately resolve setting enumerations and structure.

## Common Commands

This project uses [uv](https://docs.astral.sh/uv/) for dependency management and [just](https://github.com/casey/just) for task running.

```bash
# List available commands
just

# Install dependencies
just sync

# Fetch Graph API schema (requires Azure credentials in .env)
just fetch-schema

# Convert all profiles defined in mapping.yaml
just convert

# Single file conversion
uv run oib-converter --profile path/to/profile.json --output output.mobileconfig

# Run linters
just lint

# Clean generated files
just clean
```

## Architecture

### Core Components (src/oib_converter/converter.py)

- **GraphSchemaLoader**: Loads and manages the cached Microsoft Graph API schema (`cache/graph-schema.json`). Resolves setting IDs to plist keys and enumeration values. Critical for accurate conversion. Warns if schema is >90 days old.

- **SettingConverter**: Transforms individual Intune settings to Apple plist format. Handles different setting types (choice, string, integer, collection, group). Returns `ConvertedSetting` dataclass with key, value, parent_dict (nesting), and payload_type.

- **MobileconfigGenerator**: Builds complete mobileconfig plist structure. Groups settings by PayloadType, handles nested dictionaries for Microsoft settings (antivirusEngine, cloudService), and manages Apple wrapper flattening.

- **BatchConverter**: Orchestrates conversion of multiple profiles defined in `mapping.yaml`. Downloads OIB profiles directly from GitHub.

### Key Design Patterns

1. **Schema-driven conversion**: All setting resolution relies on the Graph API schema. Settings not in the schema are tracked and reported as missing.

2. **PayloadType grouping**: Settings are grouped by their PayloadType (e.g., `com.microsoft.wdav`, `com.apple.SoftwareUpdate`). Each PayloadType becomes a separate inner payload.

3. **Nested settings**: Microsoft settings use parent_dict for nesting (e.g., `antivirusEngine/enforcementLevel`). Apple settings are flattened at the PayloadType root.

4. **String boolean conversion**: Graph API stores booleans as strings ("true"/"false"). These are converted to proper plist booleans.

### Configuration Files

- **mapping.yaml**: Defines which OIB profiles to convert, output paths, and optional payload_type overrides
- **cache/graph-schema.json**: Cached Graph API setting definitions (generated by `just fetch-schema`)
- **.env**: Azure credentials for Graph API access (CLIENT_ID, CLIENT_SECRET, TENANT_ID)

## Requirements

- Python 3.9+
- [uv](https://docs.astral.sh/uv/) for dependency management
- [just](https://github.com/casey/just) for task running
- Azure AD app registration with `DeviceManagementConfiguration.Read.All` permission
